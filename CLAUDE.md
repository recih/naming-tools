# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Chinese character lookup tool that allows users to search for characters by:
- Selecting one or more radicals (偏旁部首)
- Filtering by five elements (五行: 金木水火土)
- Combining both radical and five element filters

Built with TanStack Start, React 18, TypeScript, and modern web technologies. Deployable to Cloudflare Workers. Commonly used for Chinese naming (起名) scenarios.

## Tech Stack

- **TanStack Start 1.134.13**: Full-stack React framework with file-based routing and SSR capabilities
- **TanStack Router 1.134.13**: Type-safe routing with auto-generated route tree and code-splitting
- **React 19**: UI framework with hooks and modern patterns
- **Vite 7.2.1**: Build tool and development server (upgraded from 5.4.21 for TanStack Start compatibility)
- **Cloudflare Workers**: Serverless deployment platform via Wrangler 4.45.4
- **Tailwind CSS v4**: Utility-first CSS framework using @tailwindcss/vite plugin
- **Zustand**: Lightweight state management with localStorage persistence
- **cnchar**: Chinese character processing library with radical, poly, and info plugins
- **shadcn/ui**: Accessible component system built on Radix UI primitives
- **Biome 2.2.4**: Fast formatter and linter (replaces ESLint/Prettier)

## Essential Commands

```bash
# Development
pnpm install                              # Install dependencies
git submodule update --init --recursive   # Initialize chinese-xinhua data submodule
pnpm cf-typegen                           # Generate Cloudflare Workers type definitions (required before first run)
pnpm r2-upload                            # Upload word.json to R2 bucket (required before first run)
pnpm dev                                  # Start dev server (http://localhost:5173)

# Code Quality
pnpm check                                # Run Biome format and linting with fix

# Build & Deploy
pnpm build                                # Build for production
pnpm preview                              # Preview production build locally
pnpm deploy                               # Build and deploy to Cloudflare Workers
pnpm cf-typegen                           # Generate Cloudflare binding types

# R2 Data Management
pnpm r2-upload                            # Upload word.json to production R2 bucket
pnpm r2-upload:local                      # Upload word.json to local R2 bucket (for wrangler dev)
```

**Note**: cnchar plugins (`cnchar-radical`, `cnchar-poly`, `cnchar-info`) are initialized in two places:
- `src/main.tsx`: For client-side rendering
- `src/data/loader.ts`: SSR-safe initialization with `typeof window !== 'undefined'` check

## Architecture

### Routing Architecture (TanStack Start)

The application uses **file-based routing** with TanStack Router:

- **`src/routes/__root.tsx`**: Root layout component with header, navigation, and detail panel
  - Imports CSS directly via `import '@/index.css'`
  - Contains `NotFound` component for 404 handling
  - Runs in CSR (Client-Side Rendering) mode with `ssr: false`

- **`src/routes/index.tsx`**: Search page (/) with RadicalSelector, FiveElementSelector, and SearchResults

- **`src/routes/favorites.tsx`**: Favorites page (/favorites) with FavoritesView

- **`src/router.tsx`**: Router configuration exporting both `getRouter()` and `createRouter()` for TanStack Start compatibility

- **`src/routeTree.gen.ts`**: Auto-generated route tree (excluded from git, regenerated by `pnpm exec tsr generate`)

- **`index.html`**: HTML document structure at the project root, defines the `<div id="root">` mount point and basic meta tags

### Data Flow & Core Concepts

1. **Radical Detection with cnchar**: Uses the `cnchar` library to dynamically extract radicals from characters, NOT the static `radicals` field from chinese-xinhua data. This is critical - always use `cnchar.radical(char)` for radical operations.

2. **Five Element Detection with cnchar-info**: Uses `cnchar.info(char)` to get five element (五行) properties. The `getFiveElement()` helper in `src/data/loader.ts` extracts the `fiveElement` field from the cnchar.info() result. Returns one of: 金, 木, 水, 火, 土.

3. **Data Sources**:
   - `chinese-xinhua` submodule: Provides character data (word, pinyin, explanation) stored in Cloudflare R2
   - `Cloudflare R2`: Stores word.json (26 MB) in `naming-tools-data` bucket, served via `/api/word-json` API route
   - `cnchar-radical`: Provides accurate radical detection at runtime
   - `cnchar-info`: Provides five element (五行) data at runtime
   - Data is fetched once and cached in module-level variables with aggressive browser caching (1 year)

4. **State Management** (Zustand):
   - `useSearchStore`: Manages radical selection, five element selection, search mode (AND/OR), search results, and collapsible panel states. Auto-triggers search on radical/five element toggle.
   - `useFavoritesStore`: Manages favorites with localStorage persistence via Zustand's `persist` middleware (SSR-safe with custom storage implementation).
   - `useDetailPanelStore`: Manages character detail panel state and selected character.

5. **Search Algorithm** (`src/data/loader.ts`):
   - Builds a `RadicalIndex` mapping radicals → characters using `cnchar.radical()`
   - Provides `getFiveElement(char)` using `cnchar.info()` for five element lookup
   - Provides `filterByFiveElements()` to filter characters by 五行 with deduplication
   - **Supports three search modes**:
     - **Radical only**: OR/AND mode for radical matching
     - **Five element only**: Searches all characters, filters by selected elements (金木水火土)
     - **Combined**: Applies five element filter after radical search
   - **Data deduplication**: `loadCharacters()` removes duplicate entries from chinese-xinhua data to prevent React key warnings

### Key Technical Decisions

- **TanStack Start SSR/CSR Hybrid**: Application uses Client-Side Rendering (CSR) mode to maintain compatibility with cnchar library. SSR-safe checks (`typeof window !== 'undefined'`) are implemented in components that access browser-only APIs.

- **Tailwind CSS v4**: Uses `@tailwindcss/vite` plugin (NOT PostCSS plugin). Configuration is in `src/index.css` using `@import "tailwindcss"` and `@theme` directive with `oklch` color values.

- **Path Aliases**: `@/` maps to `./src/` (configured using `vite-tsconfig-paths` plugin in `vite.config.ts` and `tsconfig.json`)

- **Biome Configuration**:
  - 2-space indentation, single quotes, minimal semicolons
  - Ignores: `tsconfig.*.json` files, `chinese-xinhua` submodule, and `src/routeTree.gen.ts`
  - Auto-organize imports on save
  - Integrated with VS Code settings

- **TypeScript Configuration** (ES2022):
  - Single consolidated `tsconfig.json` (removed separate `tsconfig.app.json` and project references)
  - Target: ES2022 (upgraded from ES2020)
  - `moduleResolution: "bundler"` for modern bundler workflows
  - `types: ["vite/client", "./worker-configuration.d.ts"]` for Vite and Cloudflare Workers type definitions
  - Auto-generated `worker-configuration.d.ts` via `pnpm cf-typegen` provides type safety for Cloudflare Workers bindings
  - Strict linting with `noUnusedLocals`, `noUnusedParameters`, `noFallthroughCasesInSwitch`, `noUncheckedSideEffectImports`

- **Component Structure**:
  - `src/components/ui/`: shadcn/ui base components (Button, Card, Badge, Switch, Sheet, Select, Input, Textarea, Collapsible)
  - `src/components/`: Feature components that use stores and display character data
    - `RadicalSelector.tsx`: Radical selection with pinyin filter (collapsible)
    - `FiveElementSelector.tsx`: Five element filter UI with color-coded buttons (collapsible)
    - `CharacterCard.tsx`: Displays character with ruby pinyin, five element badge, and hover tooltip
    - `CharacterDetailPanel.tsx`: Side panel (Sheet component) showing detailed character information with SSR-safe window checks
    - `SearchResults.tsx`: Grid display of matching characters
    - `FavoritesView.tsx`: Saved favorites display with batch import/export feature

- **Cloudflare Workers Configuration**:
  - `wrangler.jsonc`: Cloudflare Workers configuration with R2 bucket binding
  - R2 bucket `naming-tools-data` bound as `WORD_DATA` for character data storage
  - API route `src/routes/api/word-json.ts` uses TanStack Start server functions (`createServerFn`) pattern for type-safe data fetching
  - Exports `getWordData()` and `getWordDataRaw()` server functions for typed R2 data access
  - Uses `env` from `cloudflare:workers` for direct access to Workers bindings
  - Serves data from R2 with 1-year browser caching (`Cache-Control: public, max-age=31536000, immutable`)
  - `nodejs_compat` compatibility flag for Node.js APIs
  - Static assets served from `public/` directory
  - SPA fallback for client-side routing
  - Cloudflare Vite plugin always enabled (in both development and production)
  - **Data Storage Solution**: Uses R2 instead of Workers Assets to bypass 25MB deployment limit (word.json is 26MB)

### Important Implementation Notes

- **SSR Safety**: All browser API access (`window`, `localStorage`, `addEventListener`) must be wrapped in `typeof window !== 'undefined'` checks to prevent SSR errors.

- **cnchar Initialization**: Must be initialized in both client entry (`src/main.tsx`) and loader module (`src/data/loader.ts`) with SSR-safe checks.

- **Radical detection**: Always use `cnchar.radical(character.word)` for radical, never `character.radicals` from chinese-xinhua data.

- **Five element detection**: Always use `getFiveElement(character.word)` which calls `cnchar.info()`, never a static field.

- **Character cards**: Use HTML `<ruby>` tags for pinyin display above characters (semantic and accessible).

- **Five element colors**: Color-coded badges follow traditional associations:
  - 金 (Metal): amber/gold background
  - 木 (Wood): green background
  - 水 (Water): blue background
  - 火 (Fire): red background
  - 土 (Earth): yellow/brown background

- **Search behavior**: Automatically triggered on radical/five element toggle - don't add manual search buttons.

- **Collapsible sections**: RadicalSelector and FiveElementSelector use shadcn Collapsible component with state managed in useSearchStore.

- **Data deduplication**: Both `loadCharacters()` and `filterByFiveElements()` use Set-based deduplication to prevent duplicate character warnings.

- **Symlink structure**: `public/chinese-xinhua` is a symlink to `chinese-xinhua/data` directory (not the entire submodule), exposing only JSON data files.

- **Favorites persistence**: Uses the full `ChineseCharacter` object, not just the word string, persisted to localStorage with SSR-safe custom storage implementation.

## Development Workflow

### First-Time Setup

Before running the development server for the first time:

1. **Install dependencies**: `pnpm install`
2. **Initialize submodule**: `git submodule update --init --recursive`
3. **Generate Cloudflare types**: `pnpm cf-typegen` (creates `worker-configuration.d.ts`)
4. **Upload data to R2**: `pnpm r2-upload` or `pnpm r2-upload:local` for local development
5. **Start dev server**: `pnpm dev`

### Daily Development

1. **Adding new routes**: Create files in `src/routes/` following TanStack Router conventions
2. **Regenerating route types**: Run `pnpm exec tsr generate` after adding/modifying routes (auto-runs on dev server start)
3. **Data changes**: Modify `src/data/loader.ts`
4. **UI state changes**: Update Zustand stores in `src/stores/`
5. **New UI components**: Use shadcn/ui primitives from `src/components/ui/` - install via shadcn MCP tools
6. **Styling**: Use Tailwind utility classes with the `cn()` helper from `src/lib/utils.ts`
7. **Linting**: Always run `pnpm lint` before committing
8. **Type checking**: Vite 7 automatically runs TypeScript checks during build (`pnpm tsc --noEmit`)

### VS Code Setup

The `.vscode/settings.json` file provides optimal development experience:
- Excludes `routeTree.gen.ts` from file watching, search, and marks it read-only
- Sets Biome as default formatter for all file types
- Enables auto-organize imports on save

## Deployment to Cloudflare Workers

### Initial Setup (One-time)

1. **Create R2 bucket** (if not already created):
   ```bash
   pnpm wrangler r2 bucket create naming-tools-data
   ```

2. **Upload character data to R2**:
   ```bash
   pnpm wrangler r2 object put naming-tools-data/chinese-xinhua/word.json --file=./chinese-xinhua/data/word.json
   ```

3. **Login to Wrangler**:
   ```bash
   pnpm wrangler login
   ```

### Regular Deployment

1. Build and deploy: `pnpm deploy`
2. The app will be deployed to `*.workers.dev` or your configured custom domain
3. Character data is served from R2 bucket via `/api/word-json` API route
4. The app runs in CSR (Client-Side Rendering) mode for maximum compatibility

### Updating Character Data

To update the word.json file in production:
```bash
pnpm r2-upload                            # Upload to production R2 bucket
# OR use the longer form:
pnpm wrangler r2 object put naming-tools-data/chinese-xinhua/word.json --file=./chinese-xinhua/data/word.json
```

For local development with wrangler dev:
```bash
pnpm r2-upload:local                      # Upload to local R2 bucket
```

**Notes**:
- The Cloudflare Vite plugin is always enabled in both development and production
- R2 bucket `naming-tools-data` must exist and be bound in `wrangler.jsonc` before deployment
- Free tier supports ~33,000 users/day with unlimited bandwidth (egress is free)

## Type Definitions

Key types defined in `src/types/index.ts`:

- **`FiveElement`**: Union type for five elements
  ```typescript
  type FiveElement = '金' | '木' | '水' | '火' | '土'
  ```

- **`SearchMode`**: Union type for radical search modes
  ```typescript
  type SearchMode = 'AND' | 'OR'
  ```

- **`ChineseCharacter`**: Main character data type
  ```typescript
  interface ChineseCharacter {
    word: string
    pinyin: string
    explanation: string
    // Note: fiveElement field is computed on-demand via getFiveElement(), not stored
  }
  ```

- **`RadicalIndex`**: Mapping from radicals to characters
  ```typescript
  interface RadicalIndex {
    [radical: string]: ChineseCharacter[]
  }
  ```

## File Structure

```
naming-tools/
├── .claude/                         # Claude Code agent configurations
│   └── agents/                      # shadcn/ui specialized agents
├── .vscode/                         # VS Code workspace settings
│   └── settings.json               # Biome formatter, file exclusions
├── chinese-xinhua/                  # Git submodule: Character database
├── public/
│   └── chinese-xinhua/             # Symlink to chinese-xinhua/data
├── src/
│   ├── components/
│   │   ├── ui/                     # shadcn/ui base components
│   │   ├── CharacterCard.tsx       # Character display with ruby pinyin
│   │   ├── CharacterDetailPanel.tsx # Side panel (Sheet) with character details
│   │   ├── FavoritesView.tsx       # Favorites page with batch import/export
│   │   ├── FiveElementSelector.tsx # Five element filter (collapsible)
│   │   ├── RadicalSelector.tsx     # Radical selection (collapsible)
│   │   └── SearchResults.tsx       # Character search results grid
│   ├── data/
│   │   └── loader.ts               # Data loading with cnchar integration
│   ├── lib/
│   │   └── utils.ts                # cn() utility for className merging
│   ├── routes/                     # TanStack Router file-based routes
│   │   ├── __root.tsx              # Root layout component (CSR mode)
│   │   ├── index.tsx               # Search page (/)
│   │   └── favorites.tsx           # Favorites page (/favorites)
│   ├── stores/                     # Zustand state management
│   │   ├── useDetailPanelStore.ts  # Detail panel state
│   │   ├── useFavoritesStore.ts    # Favorites with localStorage
│   │   └── useSearchStore.ts       # Search and filter state
│   ├── types/
│   │   └── index.ts                # TypeScript type definitions
│   ├── index.css                   # Tailwind CSS v4 configuration
│   ├── main.tsx                    # Client entry with StartClient
│   ├── router.tsx                  # Router configuration
│   └── routeTree.gen.ts            # Auto-generated (git-ignored)
├── biome.json                      # Biome formatter/linter config
├── components.json                 # shadcn/ui configuration
├── tsr.config.json                 # TanStack Router codegen config
├── tsconfig.json                   # Consolidated TypeScript config (ES2022)
├── tsconfig.node.json              # Node TypeScript config
├── vite.config.ts                  # Vite 7 configuration
├── worker-configuration.d.ts       # Cloudflare Workers type definitions (auto-generated)
└── wrangler.jsonc                  # Cloudflare Workers config
```

## Recent Updates (Updated: 2025-01-07)

### Migration to TanStack Start (commit cab2d72)
- **Major architectural change**: Migrated from Vite SPA to TanStack Start 1.134.13 with full-stack capabilities
- **File-based routing**: Converted tab-based navigation to file-based routes (/, /favorites)
- **Vite upgrade**: Upgraded from 5.4.21 to 7.2.1 for TanStack Start compatibility
- **CSR mode**: Application runs in pure Client-Side Rendering mode (`ssr: false`)
- **Cloudflare Workers**: Added deployment support with always-enabled Cloudflare Vite plugin
- **New dependencies**: TanStack Router, TanStack Start, @cloudflare/vite-plugin, Wrangler
- **CSS loading**: Direct CSS import via `import '@/index.css'` in root route
- **Bug fixes**:
  - Fixed infinite HMR loop by reordering Vite plugins
  - Fixed HTML hydration error by removing shellComponent in CSR mode
  - Fixed SSR errors in CharacterDetailPanel and useFavoritesStore
  - Fixed cnchar initialization warnings

### Cloudflare Workers Integration Refactor (commits 8c1df53, b3a95a8)
- **TanStack Start server functions**: Migrated API route to use `createServerFn()` pattern for type-safe data fetching
- **R2 path structure**: Updated from `word.json` to `chinese-xinhua/word.json` for better organization
- **TypeScript consolidation**: Merged `tsconfig.app.json` into single `tsconfig.json` configuration
- **Worker types**: Added auto-generated `worker-configuration.d.ts` via `wrangler types` for full type safety with Cloudflare bindings
- **Vite plugin reorganization**: Improved plugin ordering and added `vite-tsconfig-paths` for better path resolution
- **Helper scripts**: Added `pnpm r2-upload` and `pnpm r2-upload:local` for easier R2 data management
- **Biome lint fixes**: Resolved unused parameters, nested component definitions, and label accessibility issues

### Configuration Improvements (commit 2d89ea3)
- **VS Code setup**: Added `.vscode/settings.json` with Biome formatter integration and routeTree.gen.ts exclusions
- **TypeScript modernization**: Upgraded to ES2022 target with stricter linting options
- **Biome updates**: Added routeTree.gen.ts to ignore list for cleaner linting
- **Git configuration**: Updated .gitignore to include .vscode/settings.json and exclude tmp/ directory

### UI Enhancements (commit f3e81e0, 3 days ago)
- **Collapsible filters**: Added collapsible sections to RadicalSelector and FiveElementSelector
- **Batch favorites**: Implemented batch import/export functionality in FavoritesView
- **shadcn/ui components**: Added Collapsible and Textarea components
- **Agent configurations**: Added shadcn-specific Claude Code agents for better component development

### Character Detail Panel (commits 48d53dd, 4d82858)
- **Side panel**: Implemented Sheet-based detail panel for character information
- **Layout improvements**: Fixed scroll behavior and responsive design
- **Store integration**: Added useDetailPanelStore for detail panel state management

### Five Element Feature (commit df7dfc0)
- **Five element filtering**: Added complete 五行 (金木水火土) filtering system
- **Color-coded badges**: Traditional color associations for each element
- **Combined search**: Support for radical + five element combined filtering
- **Character statistics**: Display five element distribution counts

## Submodule Management

The `chinese-xinhua` submodule must be initialized after cloning:

```bash
git submodule update --init --recursive
```

If the submodule is updated upstream:

```bash
git submodule update --remote chinese-xinhua
```

## About Context7

Always use context7 when I need code generation, setup or configuration steps, or library/API documentation. This means you should automatically use the Context7 MCP tools to resolve library id and get library docs without me having to explicitly ask.

## shadcn/ui Component Builder Assistant

You are a Senior UI/UX Engineer and expert in ReactJS, TypeScript, component design systems, and accessibility. You specialize in building, extending, and customizing shadcn/ui components with deep knowledge of Radix UI primitives and advanced Tailwind CSS patterns.

Always use shadcn mcp to install components instead of create components by yourself.

### Core Responsibilities

* Follow user requirements precisely and to the letter
* Think step-by-step: describe your component architecture plan in detailed pseudocode first
* Confirm approach, then write complete, working component code
* Write correct, best practice, DRY, bug-free, fully functional components
* Prioritize accessibility and user experience over complexity
* Implement all requested functionality completely
* Leave NO todos, placeholders, or missing pieces
* Include all required imports, types, and proper component exports
* Be concise and minimize unnecessary prose

### Technology Stack Focus

* **shadcn/ui**: Component patterns, theming, and customization
* **Radix UI**: Primitive components and accessibility patterns
* **TypeScript**: Strict typing with component props and variants
* **Tailwind CSS**: Utility-first styling with shadcn design tokens
* **Class Variance Authority (CVA)**: Component variant management
* **React**: Modern patterns with hooks and composition

### Code Implementation Rules

#### Component Architecture

* Use forwardRef for all interactive components
* Implement proper TypeScript interfaces for all props
* Use CVA for variant management and conditional styling
* Follow shadcn/ui naming conventions and file structure
* Create compound components when appropriate (Card.Header, Card.Content)
* Export components with proper display names

#### Styling Guidelines

* Always use Tailwind classes with shadcn design tokens
* Use CSS variables for theme-aware styling (hsl(var(--primary)))
* Implement proper focus states and accessibility indicators
* Follow shadcn/ui spacing and typography scales
* Use conditional classes with cn() utility function
* Support dark mode through CSS variables

#### Accessibility Standards

* Implement ARIA labels, roles, and properties correctly
* Ensure keyboard navigation works properly
* Provide proper focus management and visual indicators
* Include screen reader support with appropriate announcements
* Test with assistive technologies in mind
* Follow WCAG 2.1 AA guidelines

#### shadcn/ui Specific

* Extend existing shadcn components rather than rebuilding from scratch
* Use Radix UI primitives as the foundation when building new components
* Follow the shadcn/ui component API patterns and conventions
* Implement proper variant systems with sensible defaults
* Support theming through CSS custom properties
* Create components that integrate seamlessly with existing shadcn components

#### Component Patterns

* Use composition over complex prop drilling
* Implement proper error boundaries where needed
* Create reusable sub-components for complex UI patterns
* Use render props or compound components for flexible APIs
* Implement proper loading and error states
* Support controlled and uncontrolled component modes

### Response Protocol

1. If uncertain about shadcn/ui patterns, state so explicitly
2. If you don't know a specific Radix primitive, admit it rather than guessing
3. Search for latest shadcn/ui and Radix documentation when needed
4. Provide component usage examples only when requested
5. Stay focused on component implementation over general explanations

### Knowledge Updates

When working with shadcn/ui, Radix UI, or component design patterns, search for the latest documentation and community best practices to ensure components follow current standards and accessibility guidelines.
